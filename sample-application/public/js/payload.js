var PayloadPanel = (function () {
  var settings = {
    selectors: {
      payloadColumn: '#payload-column',
      payloadInitial: '#payload-initial-message',
      payloadRequest: '#payload-request',
      payloadResponse: '#payload-response'
    },
    payloadTypes: {
      request: 'request',
      response: 'response'
    }
  }
  return {
    init: init,
    togglePanel: togglePanel
  }

  function init () {
    payloadUpdateSetup()
  }

  function togglePanel (event, element) {
    var payloadColumn = document.querySelector(settings.selectors.payloadColumn)
    if (element.classList.contains('full')) {
      element.classList.remove('full')
      payloadColumn.classList.remove('full')
    } else {
      element.classList.add('full')
      payloadColumn.classList.add('full')
    }
  }

  function payloadUpdateSetup () {
    var currentRequestPayloadSetter = Api.setRequestPayload
    Api.setRequestPayload = function (newPayloadStr) {
      currentRequestPayloadSetter.call(Api, newPayloadStr)
      displayPayload(settings.payloadTypes.request)
    }
    var currentResponsePayloadSetter = Api.setResponsePayload
    Api.setResponsePayload = function (newPayload) {
      currentResponsePayloadSetter.call(Api, newPayload)
      displayPayload(settings.payloadTypes.response)
    }
  }

  function displayPayload (typeValue) {
    var isRequest = checkRequestType(typeValue)
    if (isRequest !== null) {
      var payloadDiv = buildPayloadDomElement(isRequest)
      var payloadElement = document.querySelector(isRequest
        ? settings.selectors.payloadRequest : settings.selectors.payloadResponse)
      while (payloadElement.lastChild) {
        payloadElement.removeChild(payloadElement.lastChild)
      }
      payloadElement.appendChild(payloadDiv)
      var payloadInitial = document.querySelector(settings.selectors.payloadInitial)
      if (Api.getRequestPayload() || Api.getResponsePayload()) {
        payloadInitial.classList.add('hide')
      }
    }
  }

  function checkRequestType (typeValue) {
    if (typeValue === settings.payloadTypes.request) {
      return true
    } else if (typeValue === settings.payloadTypes.response) {
      return false
    }
    return null
  }

  function buildPayloadDomElement (isRequest) {
    var payloadPrettyString = jsonPrettyPrint(isRequest
      ? Api.getRequestPayload() : Api.getResponsePayload())
    var payloadJson = {
      'tagName': 'div',
      'children': [{
        'tagName': 'div',
        'text': isRequest ? 'User input' : 'Watson understands',
        'classNames': ['header-text']
      }, {
        'tagName': 'div',
        'classNames': ['code-line', 'responsive-columns-wrapper'],
        'children': [{
          'tagName': 'pre',
          'text': createLineNumberString((payloadPrettyString.match(/\n/g) || []).length + 1),
          'classNames': ['line-numbers']
        }, {
          'tagName': 'pre',
          'classNames': ['payload-text', 'responsive-column'],
          'html': payloadPrettyString
        }]
      }]
    }
    return Common.buildDomElement(payloadJson)
  }

  function jsonPrettyPrint (json) {
    if (json === null) {
      return ''
    }
    var convert = JSON.stringify(json, null, 2)
    convert = convert.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(
      />/g, '&gt;')
    convert = convert
      .replace(
        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
        function (match) {
          var cls = 'number'
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = 'key'
            } else {
              cls = 'string'
            }
          } else if (/true|false/.test(match)) {
            cls = 'boolean'
          } else if (/null/.test(match)) {
            cls = 'null'
          }
          return '<span class="' + cls + '">' + match + '</span>'
        })
    return convert
  }

  function createLineNumberString (numberOfLines) {
    var lineString = ''
    var prefix = ''
    for (var i = 1; i <= numberOfLines; i++) {
      lineString += prefix
      lineString += i
      prefix = '\n'
    }
    return lineString
  }
}())
